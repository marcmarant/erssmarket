
{% extends "base/base.html" %}

{% block title %}Selector de productos{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/carrito.css') }}">
{% endblock %}

{% block content %}
     <div class="contenedor">
        <div class="contenedor1">
            <div class="contenedor3">
                <p><b>Precio Total 200â‚¬</b></p>
            </div>
            <div class="contenedor4"><button id="pagarCarrito">Pagar Carrito</button>
            </div>
        </div>

        <br>
        <br>

        {% for producto in carrito %}
            <div class="contenedor2">
                <div class="contenedor5">
                    <div class="contenedor8">
                        <img src={{producto.fotoUrl}} />
                    </div>
                    <div class="contenedor7">
                        <p><b>{{ producto.nombre }}</b></p>
                    </div>
                </div>
                <div class="contenedor6">
                    <div class="contenedor7">
                        <p>Unidades: {{ producto.cantidad }} Precio Total {{ producto.precio }}</p>
                    </div>
                    <div class="contenedor8">
                        <button id="quitarItem">Quitar Del Carrito</button>
                    </div>
                </div>
            </div>
        {% endfor %}

        <br><br>

        <button id="vaciarCarrito">Vaciar Carrito</button>
    </div>
{% endblock %}


{% block script %}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const cajasProducto = document.querySelectorAll(".producto");

            cajasProducto.forEach(productoEl => {
                const productoId = productoEl.dataset.id;

                const inputNombre    = productoEl.querySelector('input[name="nombre"]');
                const textareaDesc   = productoEl.querySelector('textarea[name="descripcion"]');
                const inputPrecio    = productoEl.querySelector('input[name="precio"]');
                const inputUnidades  = productoEl.querySelector('input[name="unidades"]');

                const btnGuardar  = productoEl.querySelector("#guardar");
                const btnCancelar = productoEl.querySelector("#cancelar");
                const btnCambiar  = productoEl.querySelector("#cambiar");

                btnGuardar.addEventListener("click", function() {
                    let diferencias = 0;
                    const payload = {};

                    if (inputNombre.value.trim() !== inputNombre.dataset.original) {
                        diferencias++;
                        payload.nombre = inputNombre.value.trim();
                    }

                    if (textareaDesc.value.trim() !== textareaDesc.dataset.original) {
                        diferencias++;
                        payload.descripcion = textareaDesc.value.trim();
                    }

                    if (inputPrecio.value !== inputPrecio.dataset.original) {
                        diferencias++;
                        payload.precio = parseFloat(inputPrecio.value);
                    }

                    if (inputUnidades.value !== inputUnidades.dataset.original) {
                        diferencias++;
                        payload.stock = parseInt(inputUnidades.value);
                    }

                    if (diferencias === 0) {
                        restaurarOriginal(productoEl);
                        alternarEdicion(productoEl, false);
                        return;
                    }

                    const metodo = diferencias === 1 ? 'PATCH' : 'PUT';

                    fetch(`/productos/${productoId}`, {
                        method: metodo,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                    .then(res => {
                        if (!res.ok) throw new Error('Error al actualizar el producto');
                        return res.json();
                    })
                    .then(data => {
                        alert("Producto actualizado correctamente.");
                        location.reload();  // Puedes actualizar campos manualmente si prefieres evitar reload
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Error al guardar cambios.");
                    });
                });

                btnCambiar.addEventListener("click", () => {
                    alternarEdicion(productoEl, true);
                });

                btnCancelar.addEventListener("click", () => {
                    restaurarOriginal(productoEl);
                    alternarEdicion(productoEl, false);
                });

                function alternarEdicion(producto, modoEdicion) {
                    const spans = producto.querySelectorAll(".texto-plano");
                    const inputs = producto.querySelectorAll(".editable");

                    spans.forEach(span => {
                        span.style.display = modoEdicion ? "none" : "inline";
                    });
                    inputs.forEach(input => {
                        input.classList.toggle("oculto", !modoEdicion);
                    });
                }

                function restaurarOriginal(producto) {
                    const inputs = producto.querySelectorAll(".editable");
                    inputs.forEach(input => {
                        input.value = input.dataset.original;
                    });
                }
            });
        });
    </script>


{% endblock %}


